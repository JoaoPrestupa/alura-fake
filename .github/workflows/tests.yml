name: Tests and Coverage

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

permissions:
  contents: read
  checks: write
  pull-requests: write

jobs:
  test:
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: alurafake_test
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3

    steps:
    - name: Checkout código
      uses: actions/checkout@v4

    - name: Configurar JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: maven

    - name: Aguardar MySQL iniciar
      run: |
        for i in {1..30}; do
          if mysqladmin ping -h"127.0.0.1" -P3306 -uroot -proot --silent; then
            echo "MySQL está pronto!"
            break
          fi
          echo "Aguardando MySQL... ($i/30)"
          sleep 2
        done

    - name: Limpar banco de dados de teste
      run: |
        mysql -h127.0.0.1 -P3306 -uroot -proot -e "DROP DATABASE IF EXISTS alurafake_test; CREATE DATABASE alurafake_test;"
        echo "Banco de dados limpo e recriado com sucesso!"

    - name: Executar testes com Maven
      env:
        SPRING_DATASOURCE_URL: jdbc:mysql://localhost:3306/alurafake_test?useSSL=false&serverTimezone=UTC&createDatabaseIfNotExist=true
        SPRING_DATASOURCE_USERNAME: root
        SPRING_DATASOURCE_PASSWORD: root
      run: mvn clean test

    - name: Gerar relatório de cobertura
      run: mvn verify

    - name: Verificar cobertura mínima (90%)
      run: |
        echo "Verificando cobertura de testes..."
        # O build falhará se a cobertura for menor que 90%
        # Isso será configurado no pom.xml com Jacoco

    - name: Publicar relatório de testes
      if: always()
      uses: dorny/test-reporter@v1
      with:
        name: Resultados dos Testes
        path: target/surefire-reports/*.xml
        reporter: java-junit
        fail-on-error: true

    - name: Comentar cobertura no PR
      if: github.event_name == 'pull_request'
      uses: madrapps/jacoco-report@v1.6.1
      with:
        paths: target/site/jacoco/jacoco.xml
        token: ${{ secrets.GITHUB_TOKEN }}
        min-coverage-overall: 30
        min-coverage-changed-files: 30
        title: 'Relatório de Cobertura de Código'
        update-comment: true

